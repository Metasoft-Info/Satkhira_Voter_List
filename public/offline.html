<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® - ‡¶∏‡¶æ‡¶§‡¶ï‡ßç‡¶∑‡ßÄ‡¶∞‡¶æ-‡ß® ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full text-center">
        <div class="w-20 h-20 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
            </svg>
        </div>
        
        <h1 class="text-2xl font-bold text-white mb-3">‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á</h1>
        <p class="text-purple-200 mb-2">
            ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§
        </p>
        <p id="data-status" class="text-sm mb-4">‡¶°‡ßá‡¶ü‡¶æ ‡¶ö‡ßá‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>

        <div id="offline-search" class="space-y-4">
            <div class="relative">
                <input type="text" 
                       id="search-input"
                       placeholder="‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                       class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400">
            </div>
            <button onclick="searchOffline()" 
                    class="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-indigo-600 transition">
                üîç ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
            </button>
        </div>

        <div id="results" class="mt-6 text-left space-y-3"></div>

        <button onclick="location.reload()" 
                class="mt-6 text-purple-300 hover:text-white transition flex items-center justify-center w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>

    <script>
        // IndexedDB for offline storage - MUST match home.blade.php settings
        const DB_NAME = 'VoterListDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'voters';
        let db;

        // Open IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('voter_id', 'voter_id', { unique: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('father_name', 'father_name', { unique: false });
                        store.createIndex('mother_name', 'mother_name', { unique: false });
                        store.createIndex('upazila', 'upazila', { unique: false });
                        store.createIndex('union', 'union', { unique: false });
                        store.createIndex('serial_no', 'serial_no', { unique: false });
                    }
                };
            });
        }

        // Search in IndexedDB
        async function searchOffline() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            if (!query) return;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="text-purple-200">üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...</p>';

            try {
                await openDB();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const results = [];

                return new Promise((resolve) => {
                    store.openCursor().onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            const voter = cursor.value;
                            const voterName = (voter.name || '').toLowerCase();
                            const voterId = (voter.voter_id || '').toLowerCase();
                            const fatherName = (voter.father_name || '').toLowerCase();
                            const motherName = (voter.mother_name || '').toLowerCase();
                            
                            if (voterId.includes(query) || 
                                voterName.includes(query) ||
                                fatherName.includes(query) ||
                                motherName.includes(query)) {
                                results.push(voter);
                            }
                            if (results.length < 50) {
                                cursor.continue();
                            } else {
                                displayResults(results);
                                resolve();
                            }
                        } else {
                            displayResults(results);
                            resolve();
                        }
                    };
                });
            } catch (error) {
                resultsDiv.innerHTML = `<p class="text-red-300">‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}</p>`;
            }
        }

        function displayResults(voters) {
            const resultsDiv = document.getElementById('results');
            if (voters.length === 0) {
                resultsDiv.innerHTML = '<p class="text-yellow-300">‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡ßá ‡¶π‡¶Ø‡¶º‡•§</p>';
                return;
            }

            resultsDiv.innerHTML = `
                <p class="text-green-300 mb-3">‚úÖ ${voters.length} ‡¶ú‡¶® ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá</p>
                ${voters.map(v => `
                    <div class="bg-white/10 rounded-lg p-3 border border-white/20">
                        <p class="font-semibold text-white">${v.name || 'N/A'}</p>
                        <p class="text-sm text-purple-200">‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç: ${v.voter_id || 'N/A'}</p>
                        <p class="text-sm text-purple-300">‡¶™‡¶ø‡¶§‡¶æ: ${v.father_name || 'N/A'}</p>
                        <p class="text-sm text-purple-300">‡¶Æ‡¶æ‡¶§‡¶æ: ${v.mother_name || 'N/A'}</p>
                        <p class="text-xs text-purple-400 mt-1">${v.union || ''}, ${v.upazila || ''}</p>
                    </div>
                `).join('')}
            `;
        }

        // Check data count on load
        async function checkDataAvailability() {
            try {
                await openDB();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const countRequest = store.count();
                
                countRequest.onsuccess = () => {
                    const count = countRequest.result;
                    if (count > 0) {
                        document.getElementById('data-status').innerHTML = 
                            `<span class="text-green-300">‚úÖ ${count.toLocaleString('bn-BD')} ‡¶ú‡¶® ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶Ü‡¶õ‡ßá</span>`;
                    } else {
                        document.getElementById('data-status').innerHTML = 
                            `<span class="text-yellow-300">‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®‡•§</span>`;
                    }
                };
            } catch (error) {
                console.error('Database check error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkDataAvailability();
        });
        
        // Allow Enter key to search
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchOffline();
        });
    </script>
</body>
</html>
